<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="./pong-favicon.ico">
  <title>Pong</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Persist language BEFORE paint (same as portal) -->
  <script>
    (function () {
      var KEY = 'portal.lang';
      var m = (location.search.match(/[?&]lang=(en|fr|zh)\b/) || [])[1];
      var saved = localStorage.getItem(KEY);
      var lang = m || saved || 'en';
      document.documentElement.setAttribute('lang', lang);
      localStorage.setItem(KEY, lang);
      var titles = { en: 'Pong', fr: 'Pong', zh: '乒乓球' };
      document.title = titles[lang] || titles.en;
    })();
  </script>

  <style>
    body {
      margin: 0;
      background: #666;
      font-family: Arial, sans-serif;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-height: 100vh;
      justify-content: center;
    }

    /* Show only active language */
    :root [lang] {
      display: none;
    }

    html[lang="en"] [lang="en"],
    html[lang="fr"] [lang="fr"],
    html[lang="zh"] [lang="zh"] {
      display: inline;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 20px;
      font-weight: 600;
    }

    .hint {
      font-size: 12px;
      opacity: .9;
      margin-bottom: 10px;
      text-align: center;
      line-height: 1.4;
    }

    canvas {
      border: 2px solid #fff;
      background-color: #333;
      max-width: 100%;
      height: auto;
    }

    .mobile-controls {
      display: grid;
      grid-template-columns: repeat(4, 64px);
      gap: 8px;
      margin-top: 10px;
    }

    .mobile-controls button {
      height: 48px;
      border: 0;
      border-radius: 6px;
      background: #222;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      box-shadow: inset -3px -3px 0 #111, inset 3px 3px 0 #444;
    }

    .mobile-controls button:active {
      transform: translateY(1px);
      background: #1a1a1a;
    }

    @media (max-width: 480px) {
      .mobile-controls {
        grid-template-columns: repeat(2, 120px);
      }
    }
  </style>
</head>

<body>
  <link rel="stylesheet" href="platform/platform.css">
  <script src="platform/platform.js"></script>
  <script>PlatformSDK.startGame('PONG');</script> <!-- Use a unique ID per game -->

  <!-- Title -->
  <h1 lang="en">Pong</h1>
  <h1 lang="fr">Pong</h1>
  <h1 lang="zh">乒乓球</h1>

  <!-- Control hints -->
  <div class="hint">
    <span lang="en">Left: W/S &nbsp;•&nbsp; Right: ↑/↓</span>
    <span lang="fr">Gauche&nbsp;: W/S &nbsp;•&nbsp; Droite&nbsp;: ↑/↓</span>
    <span lang="zh">左侧：W/S &nbsp;•&nbsp; 右侧：↑/↓</span>
  </div>

  <canvas id="pongCanvas" width="800" height="400"></canvas>

  <button id="soundBtn" style="
    margin:8px 0;padding:8px 12px;border:1px solid #444;border-radius:6px;
    background:#222;color:#fff;cursor:pointer
  ">Sound: On</button>

  <!-- Simple mobile controls (Left Up/Down, Right Up/Down) -->
  <div class="mobile-controls" aria-hidden="false">
    <button id="LUP" lang="en">Left ↑</button>
    <button id="LDN" lang="en">Left ↓</button>
    <button id="RUP" lang="en">Right ↑</button>
    <button id="RDN" lang="en">Right ↓</button>

    <button id="LUP_fr" lang="fr">Gauche ↑</button>
    <button id="LDN_fr" lang="fr">Gauche ↓</button>
    <button id="RUP_fr" lang="fr">Droite ↑</button>
    <button id="RDN_fr" lang="fr">Droite ↓</button>

    <button id="LUP_zh" lang="zh">左 ↑</button>
    <button id="LDN_zh" lang="zh">左 ↓</button>
    <button id="RUP_zh" lang="zh">右 ↑</button>
    <button id="RDN_zh" lang="zh">右 ↓</button>
  </div>

  <script>
    // --- Tiny synth SFX for Pong (no audio files) ------------------------------
    const SndPong = (() => {
      let ctx = null, muted = false, inited = false;

      function ensure() { if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)(); }
      function unlock() { ensure(); if (ctx && ctx.state === 'suspended') ctx.resume(); }

      function blip(freq = 440, dur = 0.07, type = 'square', vol = 0.07) {
        if (muted) return; ensure(); if (!ctx) return;
        const t = ctx.currentTime, o = ctx.createOscillator(), g = ctx.createGain();
        o.type = type; o.frequency.value = freq;
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(vol, t + 0.005);
        g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
        o.connect(g); g.connect(ctx.destination);
        o.start(t); o.stop(t + dur);
      }

      function chord(freqs, step = 70, type = 'triangle', vol = 0.07, dur = 0.09) {
        if (muted) return;
        freqs.forEach((f, i) => setTimeout(() => blip(f, dur, type, vol), i * step));
      }

      function updateBtn() {
        const B = document.getElementById('soundBtn'); if (!B) return;
        const labels = {
          en: ['Sound: On', 'Sound: Off'],
          fr: ['Son : Activé', 'Son : Coupé'],
          zh: ['声音：开', '声音：关']
        };
        const l = document.documentElement.getAttribute('lang') || 'en';
        const L = labels[l] || labels.en;
        B.textContent = muted ? L[1] : L[0];
        B.setAttribute('aria-pressed', muted ? 'true' : 'false');
      }

      const play = {
        wall() { blip(260, 0.06, 'triangle', 0.06); },
        paddle(hit = 0, side = 'left') {
          const base = side === 'right' ? 380 : 360;
          const f = base + Math.min(1, Math.abs(hit)) * 140;
          blip(f, 0.06, 'square', 0.075);
        },
        score(side) {
          // small celebratory up-chirp
          side === 'left' ? chord([500, 660], 80) : chord([520, 700], 80);
        },
        serve() { chord([330, 440], 80, 'square', 0.06); }
      };

      function toggle() { muted = !muted; updateBtn(); }
      function init() {
        if (inited) return; inited = true; updateBtn();
        ['keydown', 'mousedown', 'touchstart'].forEach(ev =>
          window.addEventListener(ev, unlock, { once: true, passive: true })
        );
      }

      return { play, toggle, init };
    })();
  </script>
  <script>
    // --- PlatformSDK glue for Pong ------------------------------------------------
    const WIN_SCORE = 7;         // first to 7 wins
    let rally = 0;               // counts paddle hits this rally
    let gameOver = false;

    // End the session cleanly
    function endMatch(winnerSide /* 'left' | 'right' */) {
      if (gameOver) return;
      gameOver = true;
      try {
        if (window.PlatformSDK) {
          PlatformSDK.addPoints(5, `Pong: match win (${winnerSide})`);
          PlatformSDK.endGame();
        }
      } catch { }
      // (Optional) simple notice; remove if you don't want alerts
      setTimeout(() => alert(`${winnerSide.toUpperCase()} wins!`), 10);
    }

    // Restart a fresh session/match
    function restartMatch() {
      paddle.left.score = 0;
      paddle.right.score = 0;
      rally = 0;
      gameOver = false;
      resetBall();
      try { window.PlatformSDK && PlatformSDK.startGame('PONG'); } catch { }
    }

    // Safety: end session on tab close
    window.addEventListener('beforeunload', () => { try { window.PlatformSDK && PlatformSDK.endGame(); } catch { } });

    // Hook Enter to restart after a match
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && gameOver) restartMatch();
    });
  </script>

  <script>
    const canvas = document.getElementById('pongCanvas');
    const ctx = canvas.getContext('2d');

    // Game objects
    const ball = {
      x: canvas.width / 2,
      y: canvas.height / 2,
      size: 10,
      speed: 7,
      dx: 7,
      dy: 7
    };

    const paddle = {
      width: 10,
      height: 100,
      left: { y: canvas.height / 2 - 50, score: 0 },
      right: { y: canvas.height / 2 - 50, score: 0 }
    };

    // Key state
    const keys = { w: false, s: false, ArrowUp: false, ArrowDown: false };

    // Keyboard controls
    document.addEventListener('keydown', (e) => { if (e.key in keys) keys[e.key] = true; });
    document.addEventListener('keyup', (e) => { if (e.key in keys) keys[e.key] = false; });

    // Mobile buttons helper: press & release set/unset virtual keys
    function bindHold(btn, setKey, releaseKey = setKey) {
      const press = () => { keys[setKey] = true; };
      const release = () => { keys[releaseKey] = false; };
      btn.addEventListener('mousedown', press);
      btn.addEventListener('touchstart', (e) => { e.preventDefault(); press(); }, { passive: false });
      ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach(ev => btn.addEventListener(ev, release));
    }

    // Bind visible buttons by id if present
    [['LUP', 'w'], ['LDN', 's'], ['RUP', 'ArrowUp'], ['RDN', 'ArrowDown'],
    ['LUP_fr', 'w'], ['LDN_fr', 's'], ['RUP_fr', 'ArrowUp'], ['RDN_fr', 'ArrowDown'],
    ['LUP_zh', 'w'], ['LDN_zh', 's'], ['RUP_zh', 'ArrowUp'], ['RDN_zh', 'ArrowDown']]
      .forEach(([id, key]) => {
        const el = document.getElementById(id);
        if (el) bindHold(el, key);
      });

    function movePaddles() {
      // Left paddle
      if (keys.w && paddle.left.y > 0) paddle.left.y -= 8;
      if (keys.s && paddle.left.y < canvas.height - paddle.height) paddle.left.y += 8;

      // Right paddle
      if (keys.ArrowUp && paddle.right.y > 0) paddle.right.y -= 8;
      if (keys.ArrowDown && paddle.right.y < canvas.height - paddle.height) paddle.right.y += 8;
    }

    function updateBall() {
      ball.x += ball.dx;
      ball.y += ball.dy;

      // Top/Bottom collision
      if (ball.y + ball.size > canvas.height || ball.y - ball.size < 0) {
        ball.dy *= -1;
        SndPong.play.wall();
      }

      // Left paddle collision
      if (
        ball.x - ball.size < paddle.width &&
        ball.y > paddle.left.y &&
        ball.y < paddle.left.y + paddle.height
      ) {
        ball.dx = Math.abs(ball.dx);
        ball.x = paddle.width + ball.size;
        // small angle tweak based on hit position
        const hit = (ball.y - (paddle.left.y + paddle.height / 2)) / (paddle.height / 2);
        ball.dy = Math.max(-10, Math.min(10, ball.dy + hit * 3));
        SndPong.play.paddle(hit, 'left');
        rally++;
      }

      // Right paddle collision
      if (
        ball.x + ball.size > canvas.width - paddle.width &&
        ball.y > paddle.right.y &&
        ball.y < paddle.right.y + paddle.height
      ) {
        ball.dx = -Math.abs(ball.dx);
        ball.x = canvas.width - paddle.width - ball.size;
        const hit = (ball.y - (paddle.right.y + paddle.height / 2)) / (paddle.height / 2);
        ball.dy = Math.max(-10, Math.min(10, ball.dy + hit * 3));
        SndPong.play.paddle(hit, 'right');
        rally++;
      }

      // Scoring
      if (ball.x < 0) {
        paddle.right.score++;
        SndPong.play.score('right');
        // 1 point + small rally bonus (max +3)
        try {
          if (window.PlatformSDK) {
            const bonus = Math.min(3, Math.floor(rally / 6));
            PlatformSDK.addPoints(1 + bonus, `Pong: point (right)${bonus ? ` +${bonus} rally` : ''}`);
          }
        } catch { }

        if (paddle.right.score >= WIN_SCORE) { endMatch('right'); }
        rally = 0;
        resetBall();
        return;
      }
      if (ball.x > canvas.width) {
        paddle.left.score++;
        SndPong.play.score('left');
        try {
          if (window.PlatformSDK) {
            const bonus = Math.min(3, Math.floor(rally / 6));
            PlatformSDK.addPoints(1 + bonus, `Pong: point (left)${bonus ? ` +${bonus} rally` : ''}`);
          }
        } catch { }

        if (paddle.left.score >= WIN_SCORE) { endMatch('left'); }
        rally = 0;
        resetBall();
        return;
      }
    }

    function resetBall() {
      ball.x = canvas.width / 2;
      ball.y = canvas.height / 2;
      ball.dx = -ball.dx;
      ball.dy = (Math.random() * 10 - 5) || 5;
      SndPong.play.serve();
    }

    function draw() {
      // Clear
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Ball
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.size, 0, Math.PI * 2);
      ctx.fillStyle = '#fff';
      ctx.fill();
      ctx.closePath();

      // Paddles
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, paddle.left.y, paddle.width, paddle.height);
      ctx.fillRect(canvas.width - paddle.width, paddle.right.y, paddle.width, paddle.height);

      // Center line
      ctx.setLineDash([5, 15]);
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.strokeStyle = '#fff';
      ctx.stroke();
      ctx.setLineDash([]);

      // Scores
      ctx.font = '40px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(paddle.left.score, canvas.width / 4, 50);
      ctx.fillText(paddle.right.score, canvas.width * 3 / 4, 50);
    }

    function loop() {
      movePaddles();
      updateBall();
      draw();
      requestAnimationFrame(loop);
    }

    // Start
    loop();
    SndPong.play.serve();
  </script>
  <script>
    document.getElementById('soundBtn').onclick = () => SndPong.toggle();
    SndPong.init();
  </script>
</body>

</html>