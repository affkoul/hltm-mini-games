<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" href="./breakout-favicon.ico">
    <title>Gomoku</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Persist language BEFORE paint (same contract as portal) -->
    <script>
        (function () {
            var KEY = 'portal.lang';
            var m = (location.search.match(/[?&]lang=(en|fr|zh)\b/) || [])[1];
            var saved = localStorage.getItem(KEY);
            var lang = m || saved || 'en';
            document.documentElement.setAttribute('lang', lang);
            localStorage.setItem(KEY, lang);

            var titles = { en: 'Gomoku', fr: 'Gomoku', zh: '五子棋' };
            document.title = titles[lang] || titles.en;

            // i18n strings
            window.__GOMOKU_I18N__ = {
                current: {
                    en: 'Current player',
                    fr: 'Joueur actuel',
                    zh: '当前玩家'
                },
                black: { en: 'Black', fr: 'Noir', zh: '黑棋' },
                white: { en: 'White', fr: 'Blanc', zh: '白棋' },
                restart: { en: 'Restart', fr: 'Recommencer', zh: '重启游戏' },
                again: { en: 'Play Again', fr: 'Rejouer', zh: '再玩一次' },
                win: { en: 'wins!', fr: 'a gagné !', zh: '胜利！' },
                hint: {
                    en: 'Place five stones in a row (horizontal, vertical, or diagonal) to win.',
                    fr: 'Alignez cinq pierres (horizontal, vertical ou diagonal) pour gagner.',
                    zh: '横、竖或斜线连成五子即为胜利。'
                }
            };
        })();
    </script>

    <style>
        :root [lang] {
            display: none;
        }

        /* --- Responsive board --- */
        /*:root { --board-size: min(94vmin, 94vw, 680px); }  cap on desktop, fluid on mobile */

        html[lang="en"] [lang="en"],
        html[lang="fr"] [lang="fr"],
        html[lang="zh"] [lang="zh"] {
            display: inline;
        }

        body {
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .player-turn {
            font-size: 20px;
            color: #333;
        }

        .hint {
            font-size: 12px;
            color: #555;
            text-align: center;
        }

        .chess-board {
            border: 2px solid #8b4513;
            background: #deb887;
            padding: clamp(6px, 2vmin, 12px);
            box-shadow: 0 0 10px rgba(0, 0, 0, .2);
        }

        /* Make the grid a square that fills --board-size */
        .grid {
            display: grid;
            width: var(--board-size);
            height: var(--board-size);
            grid-template-columns: repeat(15, 1fr);
            grid-template-rows: repeat(15, 1fr);

            touch-action: manipulation;
            /* better touch */
        }

        .cell {
            width: 40px;
            height: 40px;
            background: #f0d9b5;
            border: 1px solid #8b4513;
            cursor: pointer;
            position: relative;
        }

        /* Pieces scale with the cell */
        .chess-piece {
            width: 70%;
            height: 70%;
            border-radius: 50%;
            position: absolute;
            inset: 50% auto auto 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            animation: pop .12s ease-out;
        }

        .black {
            background: #000;
            border: 1px solid #333;
        }

        .white {
            background: #fff;
            border: 1px solid #999;
        }

        .restart-btn {
            padding: 10px 20px;
            font-size: 16px;
            background: #8b4513;
            color: #fff;
            border: 0;
            border-radius: 6px;
            cursor: pointer;
        }

        .restart-btn:active {
            transform: translateY(1px);
        }

        .winner-popup {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, .6);
        }

        .winner-card {
            background: #222;
            color: #fff;
            padding: 20px 28px;
            border-radius: 10px;
            text-align: center;
            min-width: 280px;
        }

        .winner-card h2 {
            margin: 0 0 6px;
            font-size: 22px;
        }

        .winner-card button {
            margin-top: 10px;
            padding: 10px 16px;
            border: 0;
            border-radius: 6px;
            background: #445;
            color: #fff;
            cursor: pointer;
        }

        /* Small “pop” when placing */
        @keyframes pop {
            from {
                transform: translate(-50%, -50%) scale(.75);
            }

            to {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* (Optional) tighter layout on very small screens for spacing around the board */
        @media (max-width: 640px) {
            .grid {
                grid-template-columns: repeat(15, 28px);
                grid-template-rows: repeat(15, 28px);
            }

            .cell {
                width: 28px;
                height: 28px;
            }

            .chess-piece {
                width: 22px;
                height: 22px;
            }
        }

        /* (Optional) tighter layout on very small screens for spacing around the board */
        @media (max-width: 420px) {
            body {
                padding: 12px;
                gap: 8px;
            }
        }
    </style>
</head>

<body>
    <link rel="stylesheet" href="platform/platform.css">
    <script src="platform/platform.js"></script>
    <script>PlatformSDK.startGame('GOMOKU');</script> <!-- Use a unique ID per game -->

    <!-- Player turn (multilingual) -->
    <div class="player-turn">
        <span lang="en">Current player: <b id="player-name-en">Black</b></span>
        <span lang="fr">Joueur actuel : <b id="player-name-fr">Noir</b></span>
        <span lang="zh">当前玩家：<b id="player-name-zh">黑棋</b></span>
    </div>
    <div class="hint">
        <span lang="en">Place five stones in a row (horizontal, vertical, or diagonal) to win.</span>
        <span lang="fr">Alignez cinq pierres (horizontal, vertical ou diagonal) pour gagner.</span>
        <span lang="zh">横、竖或斜线连成五子即为胜利。</span>
    </div>

    <div class="chess-board">
        <div class="grid" id="chess-grid" aria-label="gomoku board"></div>
    </div>

    <!-- Restart -->
    <button class="restart-btn" id="restart-btn">
        <span lang="en">Restart</span>
        <span lang="fr">Recommencer</span>
        <span lang="zh">重启游戏</span>
    </button>
    <button id="soundBtn" class="restart-btn" style="background:#445; margin-left:8px;"></button>

    <!-- Winner popup -->
    <div class="winner-popup" id="winner-popup" role="dialog" aria-modal="true">
        <div class="winner-card">
            <h2 id="winner-text"></h2>
            <button id="again-btn">
                <span lang="en">Play Again</span>
                <span lang="fr">Rejouer</span>
                <span lang="zh">再玩一次</span>
            </button>
        </div>
    </div>

    <script>
        // --- SndGomoku: tiny no-file SFX ------------------------------------------
        const SndGomoku = (() => {
            let ctx = null, inited = false;
            let muted = JSON.parse(localStorage.getItem('gomoku.muted') || 'false');

            function ensure() { if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)(); }
            function unlock() { ensure(); if (ctx && ctx.state === 'suspended') ctx.resume(); }

            function blip(freq = 440, dur = 0.08, type = 'triangle', vol = 0.07) {
                if (muted) return; ensure(); if (!ctx) return;
                const t = ctx.currentTime, o = ctx.createOscillator(), g = ctx.createGain();
                o.type = type; o.frequency.value = freq;
                g.gain.setValueAtTime(0, t);
                g.gain.linearRampToValueAtTime(vol, t + 0.006);
                g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
                o.connect(g); g.connect(ctx.destination);
                o.start(t); o.stop(t + dur);
            }
            function chord(freqs, step = 70) { freqs.forEach((f, i) => setTimeout(() => blip(f, 0.12, 'square', 0.07), i * step)); }

            const play = {
                place(color) { blip(color === 'black' ? 310 : 380, 0.08, 'triangle', 0.09); }, // different pitch per color
                bump() { blip(160, 0.09, 'sawtooth', 0.06); },                              // invalid tap
                turn() { blip(220, 0.05, 'square', 0.05); },                                // tiny tick on turn change
                win() { chord([540, 680, 820, 980], 85); },                                 // ascending arpeggio
                new() { chord([420, 560], 90); }                                            // restart
            };

            function updateBtn() {
                const B = document.getElementById('soundBtn'); if (!B) return;
                const labels = { en: ['Sound: On', 'Sound: Off'], fr: ['Son : Activé', 'Son : Coupé'], zh: ['声音：开', '声音：关'] };
                const lang = document.documentElement.getAttribute('lang') || 'en';
                const L = labels[lang] || labels.en;
                B.textContent = muted ? L[1] : L[0];
                B.setAttribute('aria-pressed', muted ? 'true' : 'false');
            }
            function toggle() { muted = !muted; updateBtn(); localStorage.setItem('gomoku.muted', JSON.stringify(muted)); }
            function init() {
                if (inited) return; inited = true; updateBtn();
                ['keydown', 'mousedown', 'touchstart'].forEach(ev => window.addEventListener(ev, unlock, { once: true, passive: true }));
            }

            return { play, toggle, init };
        })();
    </script>

    <script>
        // i18n helpers
        const I18N = window.__GOMOKU_I18N__;
        const LANG = document.documentElement.getAttribute('lang') || 'en';
        const text = (key) => (I18N[key] && (I18N[key][LANG] || I18N[key].en)) || '';

        // Board config
        const rows = 15, cols = 15;
        let currentPlayer = 'black'; // 'black' or 'white'
        let gameBoard = Array.from({ length: rows }, () => Array(cols).fill(0));
        let gameActive = true;

        // --- Platform points helper (lightly throttled) ---
        var _goPtsThrottle = 0;
        function goAddPoints(n, why) {
            if (!window.PlatformSDK) return;
            var now = Date.now();
            if (n <= 1 && now - _goPtsThrottle < 300) return; // avoid spamming 1-pt events
            _goPtsThrottle = now;
            PlatformSDK.addPoints(n, why);
        }

        const grid = document.getElementById('chess-grid');
        const winnerPopup = document.getElementById('winner-popup');
        const winnerText = document.getElementById('winner-text');

        function updateTurnLabel() {
            const name = currentPlayer === 'black' ? { en: I18N.black.en, fr: I18N.black.fr, zh: I18N.black.zh }
                : { en: I18N.white.en, fr: I18N.white.fr, zh: I18N.white.zh };
            const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            set('player-name-en', name.en);
            set('player-name-fr', name.fr);
            set('player-name-zh', name.zh);
        }

        function createBoard() {
            grid.innerHTML = '';
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.tabIndex = 0;
                    cell.setAttribute('role', 'button');
                    cell.setAttribute('aria-label', `r${i} c${j}`);
                    cell.addEventListener('click', () => handleCellClick(i, j, cell));
                    cell.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') handleCellClick(i, j, cell);
                    });
                    grid.appendChild(cell);
                }
            }
        }

        function handleCellClick(row, col, cellEl) {
            if (!gameActive || gameBoard[row][col] !== 0) { SndGomoku.play.bump(); return; }

            placePiece(cellEl, currentPlayer);
            gameBoard[row][col] = currentPlayer === 'black' ? 1 : 2;
            SndGomoku.play.place(currentPlayer);

            if (checkWin(row, col)) {
                gameActive = false;
                const who = currentPlayer === 'black' ? I18N.black[LANG] : I18N.white[LANG];
                winnerText.textContent = `${who} ${text('win')}`;
                winnerPopup.style.display = 'flex';
                SndGomoku.play.win();
                goAddPoints(1, 'Gomoku: win');
                if (window.PlatformSDK) PlatformSDK.endGame();
                return;
            }

            // Switch turn
            currentPlayer = currentPlayer === 'black' ? 'white' : 'black';
            updateTurnLabel();
            SndGomoku.play.turn();
        }

        function placePiece(cell, color) {
            const piece = document.createElement('div');
            piece.className = `chess-piece ${color}`;
            cell.appendChild(piece);
        }

        function checkWin(row, col) {
            const player = gameBoard[row][col];
            const dirs = [
                { x: 0, y: 1 },  // horizontal
                { x: 1, y: 0 },  // vertical
                { x: 1, y: 1 },  // diag down-right
                { x: 1, y: -1 }  // diag up-right
            ];
            for (const d of dirs) {
                let count = 1;
                // forward
                for (let s = 1; s <= 4; s++) {
                    const r = row + d.x * s, c = col + d.y * s;
                    if (r >= 0 && r < rows && c >= 0 && c < cols && gameBoard[r][c] === player) count++; else break;
                }
                // backward
                for (let s = 1; s <= 4; s++) {
                    const r = row - d.x * s, c = col - d.y * s;
                    if (r >= 0 && r < rows && c >= 0 && c < cols && gameBoard[r][c] === player) count++; else break;
                }
                if (count >= 5) return true;
            }
            return false;
        }

        function restartGame() {
            gameBoard = Array.from({ length: rows }, () => Array(cols).fill(0));
            currentPlayer = 'black';
            gameActive = true;
            updateTurnLabel();
            createBoard();
            winnerPopup.style.display = 'none';
            SndGomoku.play.new();
            if (window.PlatformSDK) {
                // close any prior session cleanly, then start a fresh one
                PlatformSDK.endGame();
                PlatformSDK.startGame('GOMOKU');
            }
        }

        // Buttons
        document.getElementById('restart-btn').addEventListener('click', restartGame);
        document.getElementById('again-btn').addEventListener('click', restartGame);

        // Init
        updateTurnLabel();
        createBoard();

        document.getElementById('soundBtn').onclick = () => SndGomoku.toggle();
        SndGomoku.init();
    </script>
    <script>
        // End the session if the user leaves the page
        window.addEventListener('beforeunload', function () {
            if (window.PlatformSDK) PlatformSDK.endGame();
        });
    </script>

</body>

</html>