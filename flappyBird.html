<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="./flappy-bird-favicon.ico">
    <title>Flappy Bird</title>

    <!-- Inherit language BEFORE paint -->
    <script>
        (function () {
            var KEY = 'portal.lang';
            var m = (location.search.match(/[?&]lang=(en|fr|zh)\b/) || [])[1];
            var saved = localStorage.getItem(KEY);
            var lang = m || saved || 'en';
            document.documentElement.setAttribute('lang', lang);
            localStorage.setItem(KEY, lang);

            window.__FB_I18N__ = {
                title: { en: 'Flappy Bird', fr: 'Flappy Bird', zh: 'Flappy 小鸟' },
                score: { en: 'Score', fr: 'Score', zh: '分数' },
                tap: { en: 'Tap / Space to flap', fr: 'Touchez / Espace pour voler', zh: '点击 / 空格 起飞' },
                over: { en: 'Game Over', fr: 'Partie terminée', zh: '游戏结束' },
                final: { en: 'Your score', fr: 'Votre score', zh: '你的分数' },
                again: { en: 'Play Again', fr: 'Rejouer', zh: '再玩一次' }
            };
            document.title = window.__FB_I18N__.title[lang];
        })();
    </script>

    <style>
        :root [lang] {
            display: none;
        }

        html[lang="en"] [lang="en"],
        html[lang="fr"] [lang="fr"],
        html[lang="zh"] [lang="zh"] {
            display: inline;
        }

        body {
            margin: 0;
            background: #87ceeb;
            font-family: Arial, sans-serif;
        }

        .wrap {
            max-width: 420px;
            margin: 0 auto;
            padding: 10px 10px 20px;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, .35);
            user-select: none;
        }

        .btn-sound {
            background: #2d3a4a;
            padding: 8px 10px;
            min-width: auto;
            font-size: 14px;
            border-radius: 8px;
            margin-left: 8px;
        }

        .btn-sound[aria-pressed="true"] {
            opacity: .75;
        }

        .label {
            font-size: 16px;
        }

        .score {
            font-size: 18px;
            font-weight: bold;
        }

        canvas {
            border: 2px solid #000;
            background: #9dd8f3;
            /* sky */
            display: block;
            width: 100%;
            height: auto;
            max-width: 400px;
            aspect-ratio: 2 / 3;
            /* 400x600 ratio */
            margin: 8px auto 0;
        }

        .hint {
            text-align: center;
            color: #003;
            opacity: .8;
            font-size: 14px;
            margin-top: 6px;
        }

        /* Game Over overlay */
        .overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, .55);
        }

        .card {
            background: #fff;
            color: #222;
            padding: 16px 18px;
            border-radius: 10px;
            min-width: 260px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .25);
        }

        .card h2 {
            margin: 0 0 6px;
        }

        .card p {
            margin: 6px 0 12px;
        }

        .btn {
            background: #1e90ff;
            color: #fff;
            border: 0;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            min-width: 150px;
        }

        .btn:active {
            transform: translateY(1px);
        }
    </style>
</head>

<body>
    <link rel="stylesheet" href="platform/platform.css">
    <script src="platform/platform.js"></script>

    <div class="wrap">
        <div class="topbar">
            <div class="label">
                <strong lang="en">Flappy Bird</strong>
                <strong lang="fr">Flappy Bird</strong>
                <strong lang="zh">Flappy 小鸟</strong>
            </div>
            <div class="score">
                <span lang="en">Score:</span>
                <span lang="fr">Score&nbsp;:</span>
                <span lang="zh">分数：</span>
                <span id="scoreVal">0</span>
            </div>
            <button id="soundBtn" class="btn btn-sound"></button>
        </div>

        <canvas id="gameCanvas" width="400" height="600" aria-label="flappy bird game board"></canvas>

        <div class="hint">
            <span lang="en">Tap / Space to flap</span>
            <span lang="fr">Touchez / Espace pour voler</span>
            <span lang="zh">点击 / 空格 起飞</span>
        </div>
    </div>

    <!-- Game Over -->
    <div class="overlay" id="over">
        <div class="card">
            <h2 id="overTitle"></h2>
            <p>
                <span lang="en">Your score:</span>
                <span lang="fr">Votre score&nbsp;:</span>
                <span lang="zh">你的分数：</span>
                <b id="finalScore">0</b>
            </p>
            <button class="btn" id="againBtn">
                <span lang="en">Play Again</span>
                <span lang="fr">Rejouer</span>
                <span lang="zh">再玩一次</span>
            </button>
        </div>
    </div>

    <script>
        // --- SndFlappy: tiny, no-file SFX -------------------------------------------------
        const SndFlappy = (() => {
            let ctx = null, inited = false;
            let muted = JSON.parse(localStorage.getItem('flappy.muted') || 'false');

            function ensure() { if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)(); }
            function unlock() { ensure(); if (ctx && ctx.state === 'suspended') ctx.resume(); }

            // envelope helper
            function env(node, t, dur = 0.12, vol = 0.06) {
                const g = ctx.createGain();
                g.gain.setValueAtTime(0, t);
                g.gain.linearRampToValueAtTime(vol, t + 0.01);
                g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
                node.connect(g); g.connect(ctx.destination);
                return g;
            }
            // simple osc blip
            function blip(freq = 440, dur = 0.08, type = 'square', vol = 0.06) {
                if (muted) return; ensure(); if (!ctx) return;
                const t = ctx.currentTime, o = ctx.createOscillator();
                o.type = type; o.frequency.setValueAtTime(freq, t);
                env(o, t, dur, vol); o.start(t); o.stop(t + dur);
            }
            // down or up sweep
            function sweep(from = 800, to = 220, dur = 0.18, type = 'sawtooth', vol = 0.06) {
                if (muted) return; ensure(); if (!ctx) return;
                const t = ctx.currentTime, o = ctx.createOscillator();
                o.type = type;
                o.frequency.setValueAtTime(from, t);
                o.frequency.exponentialRampToValueAtTime(Math.max(1, to), t + dur);
                env(o, t, dur, vol); o.start(t); o.stop(t + dur);
            }
            // short noise burst (for wing/crash)
            function noise(dur = 0.08, vol = 0.05) {
                if (muted) return; ensure(); if (!ctx) return;
                const sr = ctx.sampleRate, len = Math.max(1, Math.floor(sr * dur));
                const buf = ctx.createBuffer(1, len, sr);
                const data = buf.getChannelData(0);
                for (let i = 0; i < len; i++) data[i] = (Math.random() * 2 - 1) * (1 - i / len); // fade out
                const src = ctx.createBufferSource(); src.buffer = buf;
                env(src, ctx.currentTime, dur, vol); src.start();
            }
            function chord(freqs, step = 80) {
                if (muted) return; freqs.forEach((f, i) => setTimeout(() => blip(f, 0.1, 'triangle', 0.07), i * step));
            }

            const play = {
                flap() { blip(660, 0.06, 'triangle', 0.065); noise(0.04, 0.04); },   // wing + chirp
                point() { blip(900, 0.06, 'square', 0.07); },                         // score ping
                pipe() { blip(300, 0.05, 'triangle', 0.05); },                        // pipe spawn thunk
                hit() { sweep(500, 120, 0.22, 'sawtooth', 0.08); noise(0.10, 0.06); },// crash
                over() { chord([420, 320, 260], 110); },                              // sad triad
                new() { chord([520, 660], 95); }                                      // restart
            };

            function updateBtn() {
                const B = document.getElementById('soundBtn'); if (!B) return;
                const lang = document.documentElement.getAttribute('lang') || 'en';
                const L = {
                    en: ['Sound: On', 'Sound: Off'],
                    fr: ['Son : Activé', 'Son : Coupé'],
                    zh: ['声音：开', '声音：关']
                }[lang] || ['Sound: On', 'Sound: Off'];
                B.textContent = muted ? L[1] : L[0];
                B.setAttribute('aria-pressed', muted ? 'true' : 'false');
            }
            function toggle() { muted = !muted; localStorage.setItem('flappy.muted', JSON.stringify(muted)); updateBtn(); }
            function init() {
                if (inited) return; inited = true; updateBtn();
                ['keydown', 'mousedown', 'touchstart'].forEach(ev => window.addEventListener(ev, unlock, { once: true, passive: true }));
            }
            return { play, toggle, init };
        })();
    </script>

    <script>
        const I18N = window.__FB_I18N__ || {};
        const LANG = document.documentElement.getAttribute('lang') || 'en';
        const t = (k) => (I18N[k] && (I18N[k][LANG] || I18N[k].en)) || '';

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('scoreVal');
        const overEl = document.getElementById('over');
        const finalScoreEl = document.getElementById('finalScore');
        const overTitleEl = document.getElementById('overTitle');

        // --- Platform session wiring ---
        let platformSessionStarted = false;

        function platformEnsureStart() {
            if (!platformSessionStarted && window.PlatformSDK) {
                // Close any stray prior session (safe no-op if none exists)
                PlatformSDK.endGame();
                PlatformSDK.startGame('FLAPPYBIRD'); // unique id for this game
                platformSessionStarted = true;
            }
        }

        // Bird & world params (tuned for smooth play on low-end devices)
        const bird = { x: 60, y: canvas.height * 0.45, v: 0, g: 0.25, jump: -4.2, r: 12 };
        const pipes = [];
        const pipe = { w: 52, gap: 110, speed: 2.2, spawnEvery: 95, timer: 0 };
        let groundH = 56;

        let score = 0;
        let running = true;
        let rafId = 0;

        function resetState() {
            bird.y = canvas.height * 0.45; bird.v = 0;
            pipes.length = 0;
            pipe.timer = 0;
            score = 0; updateScore();
            running = true;
            overEl.style.display = 'none';
        }

        function updateScore() { scoreEl.textContent = score; }

        function flap() {
            if (!running) return;
            bird.v = bird.jump;
            SndFlappy.play.flap();
        }

        // Input: keyboard + pointer
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') { e.preventDefault(); flap(); }
        }, { passive: false });
        canvas.addEventListener('pointerdown', flap);

        function addPipe() {
            const minH = 40;
            const maxH = canvas.height - groundH - pipe.gap - minH;
            const topH = Math.floor(Math.random() * (maxH - minH)) + minH;
            pipes.push({ x: canvas.width, top: topH, passed: false });
            SndFlappy.play.pipe();
        }

        function hitTest(p) {
            // Axis-aligned checks
            const bx = bird.x, by = bird.y, br = bird.r;
            const inX = (bx + br > p.x) && (bx - br < p.x + pipe.w);
            if (!inX) return false;

            // If bird is in pipe column, check vertical gap
            const gapTop = p.top;
            const gapBot = p.top + pipe.gap;
            if (by - br < gapTop) return true;                 // hits top
            if (by + br > gapBot) return true;                 // hits bottom
            return false;
        }

        function drawBackground() {
            // sky
            ctx.fillStyle = '#9dd8f3';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // ground
            ctx.fillStyle = '#4a7020';
            ctx.fillRect(0, canvas.height - groundH, canvas.width, groundH);
        }

        function drawPipes() {
            ctx.fillStyle = '#3e6b1a';
            pipes.forEach(p => {
                // top pipe
                ctx.fillRect(p.x, 0, pipe.w, p.top);
                // bottom pipe
                const y2 = p.top + pipe.gap;
                ctx.fillRect(p.x, y2, pipe.w, canvas.height - y2);
            });
        }

        function drawBird() {
            // simple circle bird
            ctx.fillStyle = '#ffd700';
            ctx.beginPath();
            ctx.arc(bird.x, bird.y, bird.r, 0, Math.PI * 2);
            ctx.fill();
            // small eye
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(bird.x + 4, bird.y - 3, 2, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawHud() {
            ctx.fillStyle = '#fff';
            ctx.font = '24px Arial';
            ctx.fillText(`${(I18N.score?.[LANG] || 'Score')}: ${score}`, 10, 28);
        }

        function gameOver() {
            running = false;
            cancelAnimationFrame(rafId);
            overTitleEl.textContent = t('over');
            finalScoreEl.textContent = score;
            overEl.style.display = 'flex';
            SndFlappy.play.over();
            if (window.PlatformSDK) PlatformSDK.endGame();
        }

        function restart() {
            if (window.PlatformSDK) PlatformSDK.endGame();
            platformSessionStarted = false;
            resetState();
            lastTime = performance.now();
            SndFlappy.play.new();
            loop(lastTime);
        }

        document.getElementById('againBtn').addEventListener('click', restart);

        // Main loop
        let lastTime = 0;
        function loop(time) {
            platformEnsureStart();
            if (!running) return;
            rafId = requestAnimationFrame(loop);
            const dt = Math.min(32, time - lastTime); // clamp delta for stability
            lastTime = time;

            // Update bird
            bird.v += bird.g;
            bird.y += bird.v;

            // Bounds
            if (bird.y - bird.r < 0) { bird.y = bird.r; bird.v = 0; }
            if (bird.y + bird.r > canvas.height - groundH) {
                bird.y = canvas.height - groundH - bird.r;
                SndFlappy.play.hit();
                return gameOver();
            }

            // Spawn pipes
            pipe.timer += 1;
            if (pipe.timer >= pipe.spawnEvery) {
                pipe.timer = 0;
                addPipe();
            }

            // Move pipes & scoring
            for (let i = pipes.length - 1; i >= 0; i--) {
                const p = pipes[i];
                p.x -= pipe.speed;

                if (!p.passed && p.x + pipe.w < bird.x) {
                    p.passed = true;
                    score += 1;
                    updateScore();
                    SndFlappy.play.point();
                    if (window.PlatformSDK) PlatformSDK.addPoints(1, 'Flappy Bird: pipe passed');
                    // Optional milestone bonus every 10 pipes:
                    if (score % 10 === 0 && window.PlatformSDK) {
                        PlatformSDK.addPoints(1, 'Flappy Bird: +1 pipes bonus');
                    }
                }
                if (p.x + pipe.w < 0) pipes.splice(i, 1);
                if (hitTest(p)) { SndFlappy.play.hit(); return gameOver(); }
            }

            // Draw
            drawBackground();
            drawPipes();
            drawBird();
            drawHud();
        }

        // Boot
        resetState();
        lastTime = performance.now();
        loop(lastTime);
        document.getElementById('soundBtn').onclick = () => SndFlappy.toggle();
        SndFlappy.init();
        // End session if user navigates away
        window.addEventListener('beforeunload', () => {
            if (window.PlatformSDK) PlatformSDK.endGame();
        });
    </script>
</body>

</html>